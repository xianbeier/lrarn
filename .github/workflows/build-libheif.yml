name: ä¸º Windows æ„å»º libheif (å®Œæ•´æ„å»ºåŒ…)

on:
  workflow_dispatch:

jobs:
  build-static:
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºè™šæ‹Ÿä»“åº“
        run: echo "ä¸éœ€è¦æºä»£ç  â€” vcpkg ä¼šå¤„ç†æ‰€æœ‰äº‹æƒ…"

      - name: å…‹éš†å¹¶åˆå§‹åŒ– vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat
        shell: cmd

      - name: å®‰è£… libheif (é™æ€ç‰ˆæœ¬) å¹¶åŒ…å«ç¤ºä¾‹
        id: install
        run: |
          cd vcpkg
          .\vcpkg install libheif:x64-windows-static
          .\vcpkg install libheif[examples]:x64-windows-static
        shell: cmd

      - name: å¤åˆ¶æ•´ä¸ªæ„å»ºè¾“å‡ºç›®å½•
        shell: pwsh
        run: |
          # æ„å»ºè¾“å‡ºè·¯å¾„ï¼ˆvcpkg çš„æ„å»ºæ ‘ï¼‰
          $buildRoot = "${{ github.workspace }}\vcpkg\buildtrees\libheif"
          $exeDir = Get-ChildItem -Path $buildRoot -Filter "x64-windows-static-rel" -Recurse -Directory | Select-Object -First 1

          if (-not $exeDir) {
              throw "âŒ æ„å»ºç›®å½•æœªæ‰¾åˆ°ï¼å·²æŸ¥æ‰¾ä½ç½®: $buildRoot"
          }

          # åˆ›å»ºè¾“å‡ºç›®å½•
          $distDir = "${{ github.workspace }}\dist"
          New-Item -ItemType Directory -Force -Path $distDir

          # å¤åˆ¶æ•´ä¸ªæ„å»ºç›®å½•
          $buildOutputDir = Join-Path $distDir "build-output"
          Copy-Item -Path $exeDir.FullName -Destination $buildOutputDir -Recurse -Force
          Write-Host "âœ… å·²å¤åˆ¶æ•´ä¸ªæ„å»ºç›®å½•åˆ°: $buildOutputDir"

          # æ˜¾ç¤ºæ„å»ºç›®å½•å†…å®¹æ¦‚è§ˆ
          Write-Host "ğŸ“‹ æ„å»ºç›®å½•å†…å®¹æ¦‚è§ˆ:"
          Get-ChildItem -Path $buildOutputDir -Recurse | Where-Object { -not $_.PSIsContainer } | 
            Group-Object Extension | 
            Select-Object @{Name="æ–‡ä»¶ç±»å‹"; Expression={$_.Name}}, Count | 
            Format-Table -AutoSize

      - name: åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        run: |
          echo é€šè¿‡ vcpkg æ„å»ºçš„ libheif é™æ€ç‰ˆæœ¬ > ${{ github.workspace }}\dist\VERSION.txt
          echo ä¸‰å…ƒç»„: x64-windows-static >> ${{ github.workspace }}\dist\VERSION.txt
          echo æ„å»ºæ—¥æœŸ: %DATE% %TIME% >> ${{ github.workspace }}\dist\VERSION.txt
          echo æ„å»ºå†…å®¹: å®Œæ•´æ„å»ºè¾“å‡ºç›®å½• >> ${{ github.workspace }}\dist\VERSION.txt
        shell: cmd

      - name: æ˜¾ç¤ºæ„å»ºäº§ç‰©å¤§å°
        shell: pwsh
        run: |
          $distDir = "${{ github.workspace }}\dist"
          $buildOutputDir = Join-Path $distDir "build-output"
          
          if (Test-Path $buildOutputDir) {
            $size = [math]::Round((Get-ChildItem -Path $buildOutputDir -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB, 2)
            Write-Host "ğŸ“¦ æ„å»ºäº§ç‰©æ€»å¤§å°: $size MB"
          }

      - name: ä¸Šä¼ å®Œæ•´æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: libheifå®Œæ•´æ„å»ºåŒ…-windows-x64
          path: ${{ github.workspace }}\dist\
