name: Build libheif for Windows

on:
  workflow_dispatch:

jobs:
  build-static:
    runs-on: windows-latest
    steps:
      - name: Checkout dummy (not needed)
        run: echo "No source checkout needed — vcpkg will fetch libheif"

      - name: Clone vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat
        shell: cmd

      - name: Install libheif (static)
        run: |
          cd vcpkg
          .\vcpkg install libheif:x64-windows-static
        shell: cmd

      - name: Create output directory
        run: mkdir ${{ github.workspace }}\dist\bin
        shell: cmd

      - name: Copy static binaries
        shell: pwsh
        run: |
          $srcBin = "${{ github.workspace }}\vcpkg\installed\x64-windows-static\bin"
          $dstBin = "${{ github.workspace }}\dist\bin"

          Copy-Item "$srcBin\heif-enc.exe" -Destination $dstBin -Force
          Copy-Item "$srcBin\heif-dec.exe" -Destination $dstBin -Force

          Write-Host "✅ Copied static binaries: heif-enc.exe, heif-dec.exe"

      - name: Verify files exist
        shell: pwsh
        run: |
          $exe1 = "${{ github.workspace }}\dist\bin\heif-enc.exe"
          $exe2 = "${{ github.workspace }}\dist\bin\heif-dec.exe"
          if (-not (Test-Path $exe1)) { throw "heif-enc.exe not found!" }
          if (-not (Test-Path $exe2)) { throw "heif-dec.exe not found!" }
          Write-Host "✅ All binaries verified."

      - name: Create VERSION file
        run: |
          echo libheif static build via vcpkg > ${{ github.workspace }}\dist\VERSION.txt
          echo triplet: x64-windows-static >> ${{ github.workspace }}\dist\VERSION.txt
          echo build date: %DATE% %TIME% >> ${{ github.workspace }}\dist\VERSION.txt
        shell: cmd

      - name: Upload static artifact
        uses: actions/upload-artifact@v4
        with:
          name: libheif-static-windows-x64
          path: ${{ github.workspace }}\dist\
