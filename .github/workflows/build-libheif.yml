name: ä¸º Windows æ„å»º libheif (å®Œæ•´æ„å»ºåŒ…)

on:
  workflow_dispatch:

jobs:
  build-static:
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºè™šæ‹Ÿä»“åº“
        run: echo "ä¸éœ€è¦æºä»£ç  â€” vcpkg ä¼šå¤„ç†æ‰€æœ‰äº‹æƒ…"

      - name: å…‹éš†å¹¶åˆå§‹åŒ– vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat
        shell: cmd

      - name: å®‰è£… libheif (é™æ€ç‰ˆæœ¬)
        id: install
        run: |
          cd vcpkg
          .\vcpkg install libheif:x64-windows-static
        shell: cmd

      - name: æ”¶é›†æ„å»ºäº§ç‰©
        shell: pwsh
        run: |
          # åˆ›å»ºè¾“å‡ºç›®å½•
          $distDir = "${{ github.workspace }}\dist"
          $buildOutputDir = Join-Path $distDir "build-output"
          $includeDir = Join-Path $distDir "include"
          $libDir = Join-Path $distDir "lib"
          $binDir = Join-Path $distDir "bin"
          
          New-Item -ItemType Directory -Force -Path $distDir, $buildOutputDir, $includeDir, $libDir, $binDir

          # 1. å¤åˆ¶æ„å»ºæ ‘ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆç”¨äºè°ƒè¯•å’Œå®Œæ•´æ„å»ºåŒ…ï¼‰
          $buildRoot = "${{ github.workspace }}\vcpkg\buildtrees\libheif"
          $exeDir = Get-ChildItem -Path $buildRoot -Filter "x64-windows-static-rel" -Recurse -Directory | Select-Object -First 1

          if ($exeDir) {
            Copy-Item -Path $exeDir.FullName -Destination $buildOutputDir -Recurse -Force
            Write-Host "âœ… å·²å¤åˆ¶æ„å»ºç›®å½•åˆ°: $buildOutputDir"
          } else {
            Write-Host "âš ï¸ æœªæ‰¾åˆ°æ„å»ºç›®å½•: $buildRoot"
          }

          # 2. å¤åˆ¶å·²å®‰è£…çš„æ–‡ä»¶ï¼ˆå¤´æ–‡ä»¶ã€åº“æ–‡ä»¶ç­‰ï¼‰
          $installedRoot = "${{ github.workspace }}\vcpkg\installed\x64-windows-static"
          
          # å¤åˆ¶å¤´æ–‡ä»¶
          $srcInclude = Join-Path $installedRoot "include"
          if (Test-Path $srcInclude) {
            Copy-Item -Path "$srcInclude\*" -Destination $includeDir -Recurse -Force
            Write-Host "âœ… å·²å¤åˆ¶å¤´æ–‡ä»¶åˆ°: $includeDir"
          }
          
          # å¤åˆ¶åº“æ–‡ä»¶
          $srcLib = Join-Path $installedRoot "lib"
          if (Test-Path $srcLib) {
            Copy-Item -Path "$srcLib\*" -Destination $libDir -Recurse -Force
            Write-Host "âœ… å·²å¤åˆ¶åº“æ–‡ä»¶åˆ°: $libDir"
          }
          
          # å¤åˆ¶å·¥å…·å’Œå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
          $srcTools = Join-Path $installedRoot "tools"
          if (Test-Path $srcTools) {
            Copy-Item -Path "$srcTools\*" -Destination $binDir -Recurse -Force
            Write-Host "âœ… å·²å¤åˆ¶å·¥å…·åˆ°: $binDir"
          }

          # 3. æŸ¥æ‰¾å¹¶å¤åˆ¶ä»»ä½•å¯æ‰§è¡Œæ–‡ä»¶
          if ($exeDir) {
            $foundExes = Get-ChildItem -Path $exeDir.FullName -Filter "*.exe" -Recurse
            if ($foundExes) {
              foreach ($exe in $foundExes) {
                Copy-Item $exe.FullName -Destination $binDir -Force
                Write-Host "âœ… å·²å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶: $($exe.Name)"
              }
            } else {
              Write-Host "âš ï¸ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
            }
          }

          # æ˜¾ç¤ºæ„å»ºäº§ç‰©å†…å®¹æ¦‚è§ˆ
          Write-Host "ğŸ“‹ æ„å»ºäº§ç‰©å†…å®¹æ¦‚è§ˆ:"
          Get-ChildItem -Path $distDir -Recurse | Where-Object { -not $_.PSIsContainer } | 
            Group-Object { $_.Extension.ToLower() } | 
            Select-Object @{Name="æ–‡ä»¶ç±»å‹"; Expression={$_.Name}}, Count | 
            Format-Table -AutoSize

      - name: åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        run: |
          echo é€šè¿‡ vcpkg æ„å»ºçš„ libheif é™æ€ç‰ˆæœ¬ > ${{ github.workspace }}\dist\VERSION.txt
          echo ä¸‰å…ƒç»„: x64-windows-static >> ${{ github.workspace }}\dist\VERSION.txt
          echo æ„å»ºæ—¥æœŸ: %DATE% %TIME% >> ${{ github.workspace }}\dist\VERSION.txt
          echo æ„å»ºå†…å®¹: å®Œæ•´æ„å»ºè¾“å‡ºç›®å½•å’Œå·²å®‰è£…æ–‡ä»¶ >> ${{ github.workspace }}\dist\VERSION.txt
        shell: cmd

      - name: æ˜¾ç¤ºæ„å»ºäº§ç‰©å¤§å°
        shell: pwsh
        run: |
          $distDir = "${{ github.workspace }}\dist"
          
          if (Test-Path $distDir) {
            $size = [math]::Round((Get-ChildItem -Path $distDir -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB, 2)
            Write-Host "ğŸ“¦ æ„å»ºäº§ç‰©æ€»å¤§å°: $size MB"
          }

      - name: ä¸Šä¼ å®Œæ•´æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: libheifå®Œæ•´æ„å»ºåŒ…-windows-x64
          path: ${{ github.workspace }}\dist\
