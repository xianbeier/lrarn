name: Build libheif for Windows

on:
  workflow_dispatch:

jobs:
  build-static:
    runs-on: windows-latest
    steps:
      - name: Set up vcpkg and install libheif (static)
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitURL: https://github.com/microsoft/vcpkg.git
          vcpkgTriplet: x64-windows-static
          vcpkgArguments: libheif

      - name: Create output directory
        run: |
          mkdir ${{ github.workspace }}\dist\bin
        shell: cmd

      - name: Copy static binaries (no DLLs needed!)
        shell: pwsh
        run: |
          $srcBin = "${{ github.workspace }}\vcpkg\installed\x64-windows-static\bin"
          $dstBin = "${{ github.workspace }}\dist\bin"

          # 静态构建的 EXE 不依赖任何 DLL，直接复制即可
          Copy-Item "$srcBin\heif-enc.exe" -Destination $dstBin -Force
          Copy-Item "$srcBin\heif-dec.exe" -Destination $dstBin -Force

          Write-Host "✅ Static EXEs copied. No DLLs required."

      - name: Verify no DLL dependencies (optional)
        shell: pwsh
        run: |
          $exePath = "${{ github.workspace }}\dist\bin\heif-enc.exe"
          if (Test-Path $exePath) {
              Write-Host "🔍 Checking dependencies for $exePath..."
              # 使用 dumpbin 查看导入表（应只有系统核心 DLL）
              & "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\*\bin\Hostx64\x64\dumpbin.exe" /DEPENDENTS $exePath
          }

      - name: Create VERSION file
        run: |
          echo libheif static build via vcpkg > ${{ github.workspace }}\dist\VERSION.txt
          echo triplet: x64-windows-static >> ${{ github.workspace }}\dist\VERSION.txt
          echo build date: %DATE% %TIME% >> ${{ github.workspace }}\dist\VERSION.txt
        shell: cmd

      - name: Upload static artifact
        uses: actions/upload-artifact@v4
        with:
          name: libheif-static-windows-x64
          path: ${{ github.workspace }}\dist\
