name: Build libheif for Windows

on:
  workflow_dispatch:

jobs:
  build-static:
    runs-on: windows-latest
    steps:
      - name: Checkout dummy
        run: echo "No source needed — vcpkg handles everything"

      - name: Clone and bootstrap vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat
        shell: cmd

      - name: Install libheif (static) — build only, we'll grab EXE manually
        id: install
        run: |
          cd vcpkg
          .\vcpkg install libheif:x64-windows-static
        shell: cmd

      - name: Locate and copy static EXEs from build directory
        shell: pwsh
        run: |
          # 构建输出路径（vcpkg 的构建树）
          $buildRoot = "${{ github.workspace }}\vcpkg\buildtrees\libheif"
          $exeDir = Get-ChildItem -Path $buildRoot -Filter "x64-windows-static-rel" -Recurse -Directory | Select-Object -First 1

          if (-not $exeDir) {
              throw "❌ Build directory not found! Looked in: $buildRoot"
          }

          $examplesDir = Join-Path $exeDir.FullName "examples"
          if (-not (Test-Path $examplesDir)) {
              throw "❌ examples directory not found in: $examplesDir"
          }

          # 创建输出目录
          $distBin = "${{ github.workspace }}\dist\bin"
          New-Item -ItemType Directory -Force -Path $distBin

          # 复制 heif-enc.exe 和 heif-dec.exe
          $encExe = Join-Path $examplesDir "heif-enc.exe"
          $decExe = Join-Path $examplesDir "heif-dec.exe"

          if (Test-Path $encExe) {
              Copy-Item $encExe -Destination $distBin -Force
              Write-Host "✅ Copied: heif-enc.exe"
          } else {
              throw "❌ heif-enc.exe not found in $examplesDir"
          }

          if (Test-Path $decExe) {
              Copy-Item $decExe -Destination $distBin -Force
              Write-Host "✅ Copied: heif-dec.exe"
          } else {
              throw "❌ heif-dec.exe not found in $examplesDir"
          }

      - name: Verify EXEs are static (optional)
        shell: pwsh
        run: |
          $exePath = "${{ github.workspace }}\dist\bin\heif-enc.exe"
          if (Test-Path $exePath) {
              Write-Host "🔍 Checking if $exePath is static (minimal DLL dependencies)..."
              & "dumpbin.exe" /DEPENDENTS $exePath
          }

      - name: Create VERSION file
        run: |
          echo libheif static build via vcpkg > ${{ github.workspace }}\dist\VERSION.txt
          echo triplet: x64-windows-static >> ${{ github.workspace }}\dist\VERSION.txt
          echo build date: %DATE% %TIME% >> ${{ github.workspace }}\dist\VERSION.txt
        shell: cmd

      - name: Upload static artifact
        uses: actions/upload-artifact@v4
        with:
          name: libheif-static-windows-x64
          path: ${{ github.workspace }}\dist\
