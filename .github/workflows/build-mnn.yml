name: Build MNN 
on: 
  workflow_dispatch: 

jobs: 
  build: 
    runs-on: windows-latest 
    steps: 
      - name: Checkout MNN 
        uses: actions/checkout@v4 
        with: 
          repository: alibaba/MNN 
          path: MNN 
          ref: master 
      - name: Install OpenCV
        run: |
          choco install opencv -y

      - name: 修复源代码问题
        working-directory: MNN
        run: |
          # 2. 修复 Matrix 静态成员未定义问题
          $MATRIX_FIX = @"
          // 添加在 Matrix.cpp 文件末尾
          void (*const MNN::CV::Matrix::gMapXYProcs[])(const Matrix&, float, float, Point*) = {
              nullptr
          };
          
          void (*const MNN::CV::Matrix::gMapPtsProcs[])(const Matrix&, Point*, const Point*, int) = {
              nullptr
          };
          "@
          Add-Content -Path tools/cv/Matrix.cpp -Value $MATRIX_FIX

          # 3. 设置编译器使用UTF-8编码
          Add-Content -Path CMakeLists.txt -Value "`nadd_compile_options(/utf-8)`n"

      - name: Build MNN 
        working-directory: MNN 
        run: | 
          mkdir build && cd build 
          cmake .. -DCMAKE_CXX_FLAGS="/D_USE_MATH_DEFINES /EHsc" -DMNN_LOW_MEMORY=true -DMNN_CPU_WEIGHT_DEQUANT_GEMM=true -DMNN_BUILD_LLM=true -DMNN_SUPPORT_TRANSFORMER_FUSE=true -DLLM_SUPPORT_VISION=true -DMNN_BUILD_OPENCV=true -DMNN_IMGCODECS=true -DLLM_SUPPORT_AUDIO=true -DMNN_BUILD_AUDIO=true -DBUILD_MLS=true -DMNN_BUILD_TRAIN=true -DMNN_USE_OPENCV=true -DOpenCV_DIR="C:/tools/opencv/build"
          cmake --build . --config Release
      - name: Upload artifacts 
        uses: actions/upload-artifact@v4 
        with: 
          name: mnn-build 
          path: MNN/build/Release
