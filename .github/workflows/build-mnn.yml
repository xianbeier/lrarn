name: Build llm_demo on Windows (AVX2) - No Model (Manual)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      # 1. 安装依赖工具
      - name: Install Visual Studio Build Tools
        run: |
          choco install --no-progress visualstudio2022buildtools
          choco install --no-progress visualstudio2022-workload-vctools
        shell: cmd

      - name: Install CMake
        run: |
          choco install --no-progress cmake
        shell: cmd

      # 2. 使用 git 克隆 MNN 源码（含子模块）
      - name: Clone MNN Repository with Submodules
        run: |
          git clone --recurse-submodules https://github.com/alibaba/MNN.git  MNN
        shell: cmd

      # 3. 配置 CMake (启用 AVX2 和 LLM 支持)
      - name: Configure CMake
        run: |
          cd MNN
          mkdir build && cd build
          cmake .. -G "Visual Studio 17 2022" ^
                   -DMNN_BUILD_LLM=true ^
                   -DMNN_SUPPORT_TRANSFORMER_FUSE=true ^
                   -DMNN_LOW_MEMORY=true ^
                   -DMNN_AVX2=true ^
                   -DMNN_CPU_WEIGHT_DEQUANT_GEMM=true
        shell: cmd

      # 4. 编译 MNN 和 llm_demo
      - name: Build MNN and llm_demo
        run: |
          cd MNN/build
          cmake --build . --target llm_demo --config Release
        shell: cmd

      # 5. 上传构建产物（仅 llm_demo.exe）
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: llm_demo_win_avx2
          path: MNN/build/Release/llm_demo.exe
