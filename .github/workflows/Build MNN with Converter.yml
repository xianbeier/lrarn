name: Build MNN with Converter (Windows)
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout MNN
        uses: actions/checkout@v4
        with:
          repository: alibaba/MNN
          path: MNN
          ref: master

      - name: Install Ninja
        run: |
          choco install ninja -y
          refreshenv

      - name: Generate Schema Files
        working-directory: MNN
        shell: pwsh
        run: |
          Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
          .\schema\generate.ps1

      - name: Build MNN with Converter
        working-directory: MNN
        shell: pwsh
        run: |
          mkdir build; cd build
          # 使用 PowerShell 数组避免续行问题
          $cmakeArgs = @(
            "-G", "Ninja",
            "-DCMAKE_BUILD_TYPE=Release",
            "-DMNN_BUILD_CONVERTER=ON",
            "-DMNN_BUILD_SHARED_LIBS=OFF",   # 转换工具必需
            "-DMNN_WIN_RUNTIME_MT=ON",       # 转换工具必需（/MT 静态运行时）
            "-DMNN_BUILD_PROTOBUFFER=ON",    # 内置 Protobuf
            "-DMNN_BUILD_TORCH=OFF",         # 显式关闭 TorchScript
            "-DLLM_SUPPORT_VISION=ON",
            "-DMNN_BUILD_OPENCV=ON",
            "-DMNN_IMGCODECS=ON",
            "-DLLM_SUPPORT_AUDIO=ON",
            "-DMNN_BUILD_AUDIO=ON",
            "-DBUILD_MLS=true",
            "-DMNN_LOW_MEMORY=true",
            "-DMNN_CPU_WEIGHT_DEQUANT_GEMM=true",
            "-DMNN_BUILD_LLM=true",
            "-DMNN_SUPPORT_TRANSFORMER_FUSE=true"
          )
          cmake .. @cmakeArgs
          ninja -j 4

      - name: Verify Build
        working-directory: MNN/build
        shell: pwsh
        run: |
          if (-not (Test-Path "MNNConvert.exe")) {
            Write-Error "MNNConvert.exe not found! Build failed."
            exit 1
          }
          Write-Host "✅ Build successful!" -ForegroundColor Green
          .\MNNConvert.exe -v

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mnn-windows-release
          path: |
            MNN/build/MNN.lib
            MNN/build/MNNConvert.exe
