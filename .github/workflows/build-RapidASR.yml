# .github/workflows/build.yml
name: Build RapidASR C

on:
  workflow_dispatch:  # 允许手动触发

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout RapidASR
      uses: actions/checkout@v4
      with:
        repository: RapidAI/RapidASR
        path: RapidASR
        submodules: recursive  # 如果 webrtc 是子模块（目前看起来是本地目录）

    - name: Download ONNX Runtime (Windows x64)
      working-directory: RapidASR/cpp_onnx
      run: |
        curl -L https://github.com/microsoft/onnxruntime/releases/download/v1.17.1/onnxruntime-win-x64-1.17.1.zip -o onnxruntime.zip
        7z x onnxruntime.zip -oonnxruntime
      shell: pwsh

    - name: Configure CMake
      working-directory: RapidASR/cpp_onnx
      run: |
        mkdir build
        cd build
        cmake .. -DONNXRUNTIME_DIR="$env:GITHUB_WORKSPACE/RapidASR/cpp_onnx/onnxruntime" -G "Visual Studio 17 2022" -A x64

    - name: Build Release
      working-directory: RapidASR/cpp_onnx
      run: |
        cmake --build build --config Release --parallel

    - name: Prepare Artifact
      working-directory: RapidASR/cpp_onnx
      run: |
        mkdir release_bin
        copy build\tester\Release\*.exe release_bin\
        copy onnxruntime\lib\onnxruntime.dll release_bin\

    - name: Upload EXE + DLL
      uses: actions/upload-artifact@v4
      with:
        name: RapidASR-Windows-x64
        path: RapidASR/cpp_onnx/release_bin/
